{% extends "expenses/base.html" %}

{% block content %}
<div class="expense-detail-container">
    <h1 class="expense-detail-title expense-info-title">
        <i class="fa-solid fa-file-lines"></i>
        DETALHES DA DESPESA
    </h1>
    <div class="contact-links">
        
        {% if company_admin %}
            {% if expense.status.name != "APROVADO" and expense.status.name != "RECUSADO"%}
                <a class='btn btn-link btn-approved' href="{% url "expense:approved" expense.id %}">
                    <i class="fa-regular fa-circle-check"></i>
                    APROVAR
                </a>
            
                <a class='btn btn-link btn-delete' href="{% url "expense:recused" expense.id %}">
                    <i class="fa-regular fa-circle-xmark"></i>
                    RECUSAR
                </a>
            {% endif %}

        {% elif manager %}

            {% if expense.owner != user %}
                {% if expense.status.name != "APROVADO" and expense.status.name != "RECUSADO"%}
                <a class='btn btn-link btn-approved' href="{% url "expense:approved" expense.id %}">
                    <i class="fa-regular fa-circle-check"></i>
                    APROVAR
                </a>

                <a class='btn btn-link btn-delete' href="{% url "expense:recused" expense.id %}">
                    <i class="fa-regular fa-circle-xmark"></i>
                    RECUSAR
                </a>
                {% endif %}
            {% endif %}   
        {% endif %}

        {% if expense.owner_expenses == user and expense.status.name != "APROVADO"%}
        <a class='btn btn-link btn-border-white' href="{% url "expense:expense_update" expense.id %}">
            <i class="fa-solid fa-pen-to-square"></i>
            ATUALIZAR
        </a>
        {% endif %}
    </div>
    
    <div class="expense-detail-grid center-text">
        <!-- Card de Informações Básicas -->
        <div class="expense-info-card">
            <h2 class="expense-info-title">
            <i class="fa-solid fa-circle-info"></i>
                Informações Básicas
            </h2>
            <div class="expense-info-grid">
                <div class="expense-info-item">
                    <span class="expense-info-label">
                        <i class="fa-solid fa-user"></i>
                        Solicitante
                    </span>
                    <span class="expense-info-value">{{expense.owner_expenses.first_name}} {{expense.owner_expenses.last_name}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">Categoria</span>
                    <span class="expense-info-value">
                        <span class="expense-badge">{{expense.category}}</span>
                    </span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">N° da despesa</span>
                    <span class="expense-info-value">{{expense.pk}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">N° Nota Fiscal</span>
                    <span class="expense-info-value">{{expense.nf|default:"Não informado"}}</span>
                </div>
            </div>
        </div>

        <!-- Card de Localização -->
        <div class="expense-info-card">
            <h2 class="expense-info-title">
            <i class="fa-solid fa-location-dot"></i>
                Localização
            </h2>
            <div class="expense-info-grid">
                <div class="expense-info-item">
                    <span class="expense-info-label">Fornecedor</span>
                    <span class="expense-info-value">{{expense.supply}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">Cidade</span>
                    <span class="expense-info-value">{{expense.city|default:"Não informado"}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">Estado</span>
                    <span class="expense-info-value">{{expense.state_uf|default:"Não informado"}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">Data</span>
                    <span class="expense-info-value">{{expense.date|date:"d/m/Y H:i"|default:"Não informada"}}</span>
                </div>
            </div>
        </div>

        <!-- Card de Valores -->
        <div class="expense-info-card">
            <h2 class="expense-info-title">
            <i class="fa-solid fa-hand-holding-dollar"></i>
                Valores
            </h2>
            <div class="expense-info-grid">
                <div class="expense-info-item">
                    <span class="expense-info-label">Quantidade</span>
                    <span class="expense-info-value expense-value-highlight">{{expense.amount|default:"Não informado"}}</span>
                </div>
                <div class="expense-info-item">
                    <span class="expense-info-label">Valor Total</span>
                    <span class="expense-info-value expense-value-highlight">
                        {% if expense.value %}
                            R$ {{expense.value}}
                        {% else %}
                            Não informado
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <!-- Card de Verificação -->
        <div class="expense-info-card">
            <h2 class="expense-info-title">
            <i class="fa-solid fa-wallet"></i>
                Autorização de Reembolso
            </h2>
            <div class="expense-info-grid">
                <div class="expense-info-item">
                    <span class="expense-info-label">
                        <i class="fa-solid fa-clock"></i>
                        Status
                    </span>
                    {% if expense.status.name == "PENDENTE" %}
                        <span class="expense-badge expense-pending">
                            <i class="fa-solid fa-hourglass-half"></i>
                            {{expense.status.name}}
                        </span>
                    {% elif expense.status.name == "APROVADO" %}
                        <span class="expense-badge expense-approved">
                            <i class="fa-regular fa-circle-check"></i>
                            {{expense.status.name}}
                        </span>
                    {% else %}
                        <span class="expense-badge expense-recused">
                            <i class="fa-regular fa-circle-xmark"></i>
                            {{expense.status.name}}
                        </span>
                    {% endif %}
                </div>
                    
                {% if expense.status.name == "RECUSADO" %}
                <div class="expense-info-item">
                    <span class="expense-info-label">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                        Motivo
                    </span>
                    <span class="expense-info-value">{{alert.message}}</span>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- Card de Descrição -->
        {% if expense.description %}
        <div class="expense-description-card">
            <h2 class="expense-info-title">
                <i class="fa-solid fa-note-sticky"></i>
                Descriminação da Despesa
            </h2>
            <p class="expense-description-text expense-info-value">{{expense.description}}</p>
        </div>
        {% endif %}

        <!-- Card de Imagem -->
        <div class="expense-image-card">
            <h2 class="expense-info-title">
                <i class="fa-solid fa-image"></i>
                Imagem da Nota Fiscal
            </h2>
            <div class="expense-image-wrapper">
                {% if expense.picture %}
                <a href="{{expense.picture.url}}">
                    <img src="{{expense.picture.url}}" alt="Imagem da nota fiscal de {{expense.supply}}">
                </a>
                    {% else %}
                    <p class="expense-no-image">Nenhuma imagem anexada</p>
                {% endif %}
            </div>
        </div>

        <div class="expense-image-card">
            <h2 class="expense-info-title">
                <i class="fa-solid fa-timeline"></i>
                Trilha de Auditoria
            </h2>
            <div class="expense-image-wrapper">
                <div class="main-container">
                <!-- event 1st of timeline -->
                    {% for audit in audits %}
                    <div class="text-wrapper {% cycle 'left' 'right' %}">
                        <!-- all text content of timeline -->
                        <div class="line-content">
                            <h3>
                                Despesa {{audit.get_action_display}} por 
                                {{audit.performed_by.first_name}} {{audit.performed_by.last_name}} 
                                em {{audit.created_at|date:"d/m/Y H:i"}}
                            </h3>
                            <p>{{audit.notes.message | default:""}}</p>

                            {% if audit.status.name == "PENDENTE" %}
                                <span class="icon-status-pending">
                                    <i class="fa-solid fa-hourglass-half" title="Aguardando de Aprovação"></i>
                                </span>
                            {% elif audit.status.name == "APROVADO" %}
                                <span class="icon-status-approved" title="Aprovado">
                                    <i class="fa-regular fa-circle-check"></i>
                                </span>
                            {% else %}
                                <span class="icon-status-recused" title="Recusado">
                                    <i class="fa-regular fa-circle-xmark"></i>
                                </span>
                            {% endif %}
                            
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>    
        </div>
        
    </div>

     

    <form action="{% url "expense:expense_delete" expense.id %}" method='POST'>
            {% csrf_token %}
            {% if confirmation == 'no' %}
                <input type="hidden" name="confirmation" value="yes">
                <button class="btn btn-link btn-delete" type='submit'>CONFIRMA A EXCLUSÃO ?</button>            
            {% else %}
                {% if expense.owner_expenses == user and not last_audit.is_checked %}
                <button class="btn btn-link btn-delete" type='submit'>
                    <i class="fa-solid fa-trash"></i>
                    DELETAR
                </button>
                {% endif %}            
            {% endif %}
    </form>

    
</div>
{% endblock content %}
